---
title: "01_Summary_SouthCarolina_Arctic"
author: "Gen Perkins"
date: "2024-01-05"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

## Summary of South Carolina to Arctic 

```{r library, warning=FALSE, message=FALSE, include = FALSE}
library(leaflet)
library(RColorBrewer)
library(dplyr)
library(lubridate)
library(sf)
library(adehabitatHR)
library(ggplot2)
library(stringr)
library(readxl)
library(dplyr)
library("rnaturalearth")
library("rnaturalearthdata")


raw_dat <- file.path("data", "movebank_locations_20231219")

filesoi <- list.files(raw_dat)

# data_set3 : spring migration 
key = "South Carolina"

filesoi <- list.files(raw_dat, pattern = key)
filesoi_ref <- filesoi[1]
filesoi <- filesoi[2]

# read in reference data 
brep <- read.csv(file.path(raw_dat, filesoi_ref))
brep <- brep %>%
  dplyr::select(c(tag.id , "animal.id" ,deploy.on.date, animal.life.stage, tag.model, animal.sex,deployment.comments)) %>% 
  rename("animal.ring.id" = animal.id) 

brep  <- brep [complete.cases(brep ), ]

brep <- brep %>%
mutate(tag.local.identifier = tag.id)

no.tags.ref <- unique(brep$tag.local.identifier)
no.ids.ref <- unique(brep$tag.id)


#filesoi <- list.files(raw_dat, pattern = key)

btemp <- read.csv(file.path(raw_dat, filesoi))
bout <- btemp %>%
    dplyr::select(visible, timestamp, location.long, location.lat,
                  #gps.fix.type.raw, lotek.crc.status,
                  sensor.type, individual.local.identifier,
                  argos.lc, argos.altitude, #algorithm.marked.outlier,
                  tag.local.identifier)


# calculate time differences
bout <- bout  %>%
  mutate(date_time = ymd_hms(timestamp))%>%
  mutate(year = year(date_time )) %>%
  mutate(month = month(date_time ),
         day = day(date_time),
         hour = hour(date_time),
         minute = minute(date_time))

no.tags <- unique(bout$tag.local.identifier)
no.ids <- unique(bout$individual.local.identifier)
  

ids <- bout %>%
  dplyr::select(tag.local.identifier, individual.local.identifier) %>%
  group_by(tag.local.identifier, individual.local.identifier)%>%
  summarise(n = n())
  

ymin = min(range(bout$year))
ymax = max(range(bout$year))


# merge these together and output 

brep 
bout

all_dat <- left_join(bout, brep )

head(all_dat)


# #save out file
clean_save = all_dat %>% mutate(proj = "sthcarolina_arctic")
saveRDS(clean_save, file = file.path("output", "rekn_sthcarolina_20231219.rds"))





```

This dataset has `r length(no.tags)` tags (tag.local.identifier) and `r length(no.ids)` (individual.local.identifier). 

```{r, echo = FALSE}
knitr::kable(ids)

```

```{r, echo=FALSE}

clean <- bout %>%
  filter(visible == "true")%>%
  filter(!is.na(location.long)) %>%
  filter(!is.na(location.lat))

# #save out file
clean_save = clean %>% mutate(proj = "sthcarolina_arctic")
saveRDS(clean_save, file = file.path("output", "rekn_sthcarolina_20231219.rds"))



cleanargos <- clean %>% 
  dplyr::filter(argos.lc != "Z")%>%
  dplyr::filter(argos.lc != "A")%>% 
 dplyr::filter(argos.lc != "B")

#length(cleanargos$visible)

clean = cleanargos

errrors_tble <- clean %>%
  group_by(tag.local.identifier, year, visible) %>%
  summarise(count = n())


# #save out file
clean_save = clean %>% mutate(proj = "sthcarolina_arctic")
saveRDS(clean_save, file = file.path("output", "rekn_sthcarolina_20231102.rds"))



```


# Raw data

The number of raw records as of September 2023 is `r length(bout$tag.local.identifier)`.  The raw date range varies from 
`r min(range(bout$year))` to `r max(range(bout$year))`.


If we remove all the algorithm marked outliers (lotek = error, argos accuracy value = A, B, Z). We reduce the number of observations in the data set from `r length(bout$tag.local.identifier)` to `r length(clean$tag.local.identifier)`.
Argos accuracy codes are: 

- Class 0: over 1500 m radius (not currently filtered)

- Class A: Argos no accuracy estimation (3 messages received)
- Class B: Argos no accuracy estimation (1 or 2 messages received)
- Class Z: Argos Invalid Location


The cleaned date range varies from 
`r min(range(clean$year))` to `r max(range(clean$year))`.


# GPS vs argos


The data split between gps and argos data records. Large proportion are argos doppler shift.   These represent two different methods of calculating the locations and all types can be used. 

```{r, echo = FALSE, message=FALSE}
tag_type <- clean %>%
  dplyr::select(tag.local.identifier, sensor.type) %>%
  group_by(tag.local.identifier, sensor.type)%>%
  summarise(n = n())

#tag_type

tag_type_date <- clean %>%
  dplyr::select(tag.local.identifier, sensor.type, year, month) %>%
   group_by(tag.local.identifier, sensor.type, year,month)%>%
  summarise(n = n())

#tag_type_date

#p_alldat <- ggplot(clean, aes(year, fill = sensor.type))+
#  geom_bar(position = "dodge") 

p_alldat <- ggplot(clean, aes(year, fill = sensor.type))+
  geom_bar(position = "dodge") +
  xlim(2021, 2024)+
  facet_wrap(~tag.local.identifier)+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

```