---
title: "01_Summary_Atlantic_shores"
author: "Gen Perkins"
date: "2023-06-11"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Summary of Atlantic Shores

```{r library, warning=FALSE, message=FALSE, include = FALSE}
library(leaflet)
library(RColorBrewer)
library(dplyr)
library(lubridate)
library(sf)
library(adehabitatHR)
library(ggplot2)
library(stringr)
library(readxl)
library(dplyr)
library("rnaturalearth")
library("rnaturalearthdata")


raw_dat <- file.path("data", "movebank_locations_20230724")
filesoi <- list.files(raw_dat)

# data_set3 : spring migration 
key = "Atlantic"

filesoi <- list.files(raw_dat, pattern = key)
filesoi_ref <- filesoi[1]
filesoi <- filesoi[2]

# read in reference data 
brep <- read.csv(file.path(raw_dat, filesoi_ref))
brep <- brep %>%
  dplyr::select(c(tag.id , "animal.id" ,deploy.on.date, "animal.marker.id","animal.ring.id", "tag.serial.no"))%>%
mutate(tag.local.identifier = tag.id)

no.tags.ref <- unique(brep$tag.local.identifier)
no.ids.ref <- unique(brep$animal.id)



ids <- brep %>% 
  dplyr::select(tag.local.identifier, animal.id) %>%
  distinct()

# based on the reference data there is 
# 107 unique tag ids (numeric) and 77 unique animal ids *ie NBRI_233781_2022


# read in track data

btemp <- read.csv(file.path(raw_dat, filesoi))
bout <- btemp %>%
    dplyr::select(visible, timestamp, location.long, location.lat,
                  gps.fix.type.raw, lotek.crc.status,
                  sensor.type, individual.local.identifier,
                  argos.lc, algorithm.marked.outlier,
                  tag.local.identifier)


# calculate time differences
bout <- bout %>%
  mutate(date_time = ymd_hms(timestamp))%>%
  mutate(year = year(date_time )) %>%
  mutate(month = month(date_time ),
         day = day(date_time),
         hour = hour(date_time),
         minute = minute(date_time))

no.tags <- unique(bout$tag.local.identifier)
no.ids <- unique(bout$individual.local.identifier)
  

# which ids are missing tracking data? 

# based on the tracks data there are 57 ids and animal tag nos. 
# all tracks have a animal tag id (ie: )


ids.track <- bout %>% 
  dplyr::select(tag.local.identifier, individual.local.identifier) %>%
  distinct()

fullid <- full_join(ids, ids.track)


ids <- bout %>%
  dplyr::select(tag.local.identifier, individual.local.identifier) %>%
  group_by(tag.local.identifier, individual.local.identifier)%>%
  summarise(n = n())
  

ymin = min(range(bout$year))
ymax = max(range(bout$year))
```

This dataset has some discrepancies within the reference data and the track data. The reference data show 107 tags (based on tag-id number ie. 204561). Of these I found deployment information on 78 tags, which also includes 16 tags which are duplicated in USFW study. Tracks for these 16 duplicated tags are within the atlantic tags track set. 

A review of the track data shows records for `r length(no.tags)` tags (tag.local.identifier) and `r length(no.ids)` (individual.local.identifier). 

This indicates that some tag ids listed in the reference data may not yet have been deployed (i.e 29 tags with no reference data and no deployment data)


```{r, echo = FALSE}
knitr::kable(ids)

```


```{r, echo=FALSE}

errors <- ggplot(bout, aes(year, fill = visible))+
    geom_bar(position = "dodge")#+
    #xlim(2021,2024)#+
  #facet_wrap(~tag.local.identifier)

clean <- bout %>%
  filter(visible == "true")%>%
  filter(!is.na(location.long)) %>%
  filter(!is.na(location.lat)) %>%
  filter(year <2024)
  
errors <- ggplot(clean, aes(year, fill = visible))+
    geom_bar(position = "dodge")
# errrors_tble <- bout %>%
#   group_by(tag.local.identifier, year, visible) %>%
#   summarise(count = n())


```


# Raw data

The number of records as of early June 2023 is `r length(clean$tag.local.identifier)`.  The raw date range varies from 
`r min(range(clean$year))` to `r max(range(clean$year))`. Some obvious date errors were corrected.

```{r, echp = FALSE}
errors
```


If we remove all the algorithm marked outliers (lotek = error, argos accuracy value = 0, A, B, Z). We reduce the number of observations in the data set from `r length(bout$tag.local.identifier)` to `r length(clean$tag.local.identifier)`.
The cleaned date range varies from 
`r min(range(clean$year))` to `r max(range(clean$year))`.


# GPS vs argos

The data set contains both gps and argos dopler shift location estimates. These represent two different methods of calculating the locations and all types can be used. 

```{r, echo = FALSE, message=FALSE}
tag_type <- clean %>%
  dplyr::select(tag.local.identifier, sensor.type) %>%
  group_by(tag.local.identifier, sensor.type)%>%
  summarise(n = n())

#tag_type

tag_type_date <- clean %>%
  dplyr::select(tag.local.identifier, sensor.type, year, month) %>%
   group_by(tag.local.identifier, sensor.type, year,month)%>%
  summarise(n = n())

#tag_type_date

p_alldat <- ggplot(clean, aes(year, fill = sensor.type))+
  geom_bar(position = "dodge") 

```

```{r, echo= FALSE}
p_alldat 

```

```{r, echo = FALSE}
# linking the tags to reference data

# read in reference data 
brep <- read.csv(file.path(raw_dat, filesoi_ref))
brep <- brep %>%
  dplyr::select(c(tag.id , "animal.id" ,deploy.on.date, "animal.marker.id","animal.ring.id", "tag.serial.no"))%>%
mutate(tag.local.identifier = tag.id)


alltrack <- clean %>% 
  left_join(brep) %>% 
  dplyr::select(-tag.id, -animal.id, - visible, -timestamp, -algorithm.marked.outlier)

```


# Duration of Tag summary

```{r, echo = FALSE}
# 
# p_duration <- ggplot(clean, aes(factor(month), fill = factor(year)))+
#   geom_bar(position = "dodge") +
#   #xlim(1,12)+
#   #facet_wrap(~tag.local.identifier)+
#   theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
# 
# p_duration

#alltrack

table_max <- alltrack %>% 
  dplyr::select(tag.local.identifier, date_time) %>%
 # group_by(tag.local.identifier)%>% 
  slice_max(date_time, by = tag.local.identifier)
colnames(table_max)<- c("tag.local.identifier", "max")

table_min <- alltrack %>% 
  dplyr::select(tag.local.identifier, date_time) %>%
 # group_by(tag.local.identifier)%>% 
  slice_min(date_time, by = tag.local.identifier)

colnames(table_min)<- c("tag.local.identifier", "min")

dur <- left_join(table_max, table_min,by = join_by(tag.local.identifier)) %>%
  distinct() %>%
  dplyr::mutate(duration = max- min)%>%
  mutate(dur_no = round(as.numeric(duration)/24,1))


# table_max <- clean %>% 
#   dplyr::filter(year < 2024) %>%
#   dplyr::select(tag.local.identifier, date_time) %>%
#  # group_by(tag.local.identifier)%>% 
#   slice_max(date_time, by = tag.local.identifier)
# colnames(table_max)<- c("tag.local.identifier", "max")
# 
# table_min <- clean %>% 
#     dplyr::filter(year >= 2020) %>%
#   dplyr::select(tag.local.identifier, date_time) %>%
#  # group_by(tag.local.identifier)%>% 
#   slice_min(date_time, by = tag.local.identifier)
# 
# colnames(table_min)<- c("tag.local.identifier", "min")
# 
# dur <- left_join(table_max, table_min,by = join_by(tag.local.identifier)) %>%
#   distinct()

#library(ggplot2)

dur_plot <- ggplot(dur, aes(y=factor(tag.local.identifier))) +
  geom_segment(aes(x=min, xend=max, y=factor(tag.local.identifier),    yend=factor(tag.local.identifier)), size=1)+
  xlab("Date") + ylab("Tag") 

dur_plot



dur_hist <- ggplot(dur, aes(dur_no))+
  geom_histogram(binwidth = 2) +
  xlab("duration (days)") 

dur_hist

```



# Geographic distributon of tags

```{r, echo=FALSE}
  
rf_sf <- sf::st_as_sf(clean, coords = c("location.long","location.lat"), crs = 4326, agr = "constant")

world <- ne_countries(scale = "medium", returnclass = "sf")

Americas <- world %>% dplyr::filter(region_un == "Americas")
#Americas <- world %>% dplyr::filter(continent == "North America")

# entire north America 
global <- ggplot(data = Americas) +
  geom_sf(color = "grey") +
  geom_sf(data = rf_sf, size = 1, colour = "dark blue") +
  #facet_wrap(~tag.local.identifier)+
  # geom_point(ru, aes(x = lng, y = lat), size = 4) +
  xlab("Longitude") + ylab("Latitude") +
  coord_sf(xlim = c(-130, -20), ylim = c(-50, 80), expand = FALSE)+
  theme_bw()+
  theme(axis.text.x=element_blank(),
        axis.text.y=element_blank())

global

# 
# jpeg(file.path(out.plots,"rose_density.jpg"), width = 30, height = 30,units = "cm", res = 210)
# # 2. Create the plot
# global 
```

Questions/Notes 

- many tags do not have tracks. All tracks have reference data, but many tags with reference data does not have tracks.  
- this data set includes the duplicate tracks for the spring migration dataset 
- Still to review the level of accuracy in more detail. 

Appendices: 

List of tags ids with no tracks or reference tags 

```{r, echo = FALSE}

norefnotrack = fullid %>%
  filter(is.na(individual.local.identifier))%>%
  filter(animal.id == "") %>% 
  pull(tag.local.identifier)
  
norefnotrack
# 30 

```


List of tags ids with no tracks

```{r, echo = FALSE}

refnotrack = fullid %>%
  filter(is.na(individual.local.identifier))%>%
  filter(animal.id != "") %>% 
  pull(tag.local.identifier)
  
refnotrack
#20   


```
